---
- name: Create CPU, Disk, Status checks and Memory CloudWatch alarms
  hosts: all
  become: true
  gather_facts: true
  collections:
    - amazon.aws

  vars_files:
    - ../assets/instances_details.yml

  vars:
    region: "{{ lookup('env', 'REGION_NAME') }}"
    sns_topic_arn: "{{ lookup('env', 'SNS_TOPIC') }}"
    thresholds:
      - 85
      - 95
      
    sns_actions: ["{{ sns_topic_arn }}"]
     
    disk_path: "/"

  tasks:
    - name: Run a script to gather instance details
      ansible.builtin.script: ../assets/Generate_Instance_Details.sh

    - name: Find data file on remote servers
      ansible.builtin.find:
        paths: "{{ ansible_user_dir }}"
        patterns: '^data_.*\.txt$'
        use_regex: yes
        file_type: file
      register: found_files

    - name: Create Temporary local folder
      delegate_to: localhost
      run_once: true
      become: false
      file:
        path: "../assets/instance_data"
        state: directory

    - name: Fetch files From Server
      fetch:
        src: "{{ item.path }}"
        dest: "../assets/instance_data/"
        flat: yes
      loop: "{{ found_files.files }}"
      when: found_files.matched | default(0) > 0

    - name: Delete files from remote Server
      ansible.builtin.shell: "rm -f data_*"
      args:
        chdir: "{{ ansible_user_dir }}"
      when: found_files.matched | default(0) > 0      
    

    - name: Validate required variables
      assert:
        that:
          - sns_topic_arn is defined
          - region is defined
          - instances is defined
          - instances | length > 0
        fail_msg: "Please provide correct details "

    - name: Build alarm list (instances × thresholds) with device/fstype/imageid
      set_fact:
        alarms: >-
          {{
            alarms | default([]) +
            [ {
                'instance': item[0].instance,
                'name': item[0].name,
                'threshold': item[1],
                'device': (item[0].device | default(None)),
                'fstype': (item[0].fstype | default(None)),
                'imageid': (item[0].imageid | default(None))
              } ]
          }}
      loop: "{{ instances | product(thresholds) | map('flatten') | list }}"
      loop_control:
        label: "{{ item[0].name }}:{{ item[1] }}"
      delegate_to: localhost
      run_once: true

    ####################################################################
    # CPU alarms (AWS/EC2)
    ####################################################################
    - name: Create CPU Utilization alarms (85% & 95%)
      amazon.aws.cloudwatch_metric_alarm:
        state: present
        region: "{{ region }}"
        name: "{{ alarm.name }}-CPUUtilization-{{ alarm.threshold }}%-#Alarm"
        metric_name: CPUUtilization
        namespace: AWS/EC2
        statistic: Average
        comparison: GreaterThanOrEqualToThreshold
        threshold: "{{ alarm.threshold }}"
        period: 300
        evaluation_periods: 1
        dimensions:
          InstanceId: "{{ alarm.instance }}"
        alarm_actions: "{{ sns_actions }}"
        unit: Percent
      loop: "{{ alarms }}"
      loop_control:
        loop_var: alarm
      delegate_to: localhost
      run_once: true
    ####################################################################
    # Disk alarms (CWAgent) - exact fixed dims: InstanceId, path, device, fstype, ImageId
    ####################################################################
    - name: Create Disk alarms (85% & 95%)
      vars:
        final_dims: >-
          {{
            {
              'InstanceId': alarm.instance,
              'path': disk_path,
              'device': alarm.device,
              'fstype': alarm.fstype,
              'ImageId': alarm.imageid
            }
          }}
      amazon.aws.cloudwatch_metric_alarm:
        state: present
        region: "{{ region }}"
        name: "{{ alarm.name }}-DiskUsed-{{ alarm.threshold }}%-#Alarm"
        metric_name: disk_used_percent
        namespace: CWAgent
        statistic: Average
        comparison: GreaterThanOrEqualToThreshold
        threshold: "{{ alarm.threshold }}"
        period: 300
        evaluation_periods: 1
        dimensions: "{{ final_dims }}"
        alarm_actions: "{{ sns_actions }}"
        unit: Percent
      loop: "{{ alarms }}"
      loop_control:
        loop_var: alarm
      delegate_to: localhost
      run_once: true
    ####################################################################
    # Status checks (Instance & System & AttachedEBS using InstanceId)
    ####################################################################
    - name: Create StatusCheckFailed_Instance alarms
      amazon.aws.cloudwatch_metric_alarm:
        state: present
        region: "{{ region }}"
        name: "{{ item.name }}-StatusCheck_Instance-#Alarm"
        metric_name: StatusCheckFailed_Instance
        namespace: AWS/EC2
        statistic: Maximum
        comparison: GreaterThanOrEqualToThreshold
        threshold: 1
        period: 60            
        evaluation_periods: 1
        dimensions:
          InstanceId: "{{ item.instance }}"
        alarm_actions:  ["arn:aws:automate:{{ region }}:ec2:reboot","{{ sns_topic_arn }}"]
        unit: Count
      loop: "{{ instances }}"
      loop_control:
        label: "{{ item.name }}"
        loop_var: item
      delegate_to: localhost
      run_once: true
      
    - name: Create StatusCheckFailed_System alarms
      amazon.aws.cloudwatch_metric_alarm:
        state: present
        region: "{{ region }}"
        name: "{{ item.name }}-StatusCheck_System-#Alarm"
        metric_name: StatusCheckFailed_System
        namespace: AWS/EC2
        statistic: Maximum
        comparison: GreaterThanOrEqualToThreshold
        threshold: 1
        period: 60           
        evaluation_periods: 1
        dimensions:
          InstanceId: "{{ item.instance }}"
        alarm_actions: ["{{ sns_topic_arn }}","arn:aws:automate:{{ region }}:ec2:recover"]
        unit: Count
      loop: "{{ instances }}"
      loop_control:
        label: "{{ item.name }}"
        loop_var: item
      delegate_to: localhost
      run_once: true
      
    - name: Create StatusCheckFailed_AttachedEBS alarms
      amazon.aws.cloudwatch_metric_alarm:
        state: present
        region: "{{ region }}"
        name: "{{ item.name }}-StatusCheck_AttachedEBS-#Alarm"
        metric_name: StatusCheckFailed_AttachedEBS
        namespace: AWS/EC2
        statistic: Maximum
        comparison: GreaterThanOrEqualToThreshold
        threshold: 1
        period: 60           
        evaluation_periods: 1
        dimensions:
          InstanceId: "{{ item.instance }}"
        alarm_actions: "{{ sns_actions }}"
        unit: Count
      loop: "{{ instances }}"
      loop_control:
        label: "{{ item.name }}"
        loop_var: item
      delegate_to: localhost
      run_once: true
    ####################################################################
    # Memory alarms (CWAgent) - InstanceId + ImageId
    ####################################################################
    - name: Build memory alarm list
      set_fact:
        mem_alarms: >-
          {{
            mem_alarms | default([]) +
            [ {
                'instance': item[0].instance,
                'name': item[0].name,
                'threshold': item[1],
                'imageid': item[0].imageid
              } ]
          }}
      loop: "{{ instances | product(thresholds) | map('flatten') | list }}"
      loop_control:
        label: "{{ item[0].name }} → {{ item[1] }}"
      delegate_to: localhost
      run_once: true
      
    - name: Create Memory alarms (85% & 95%) using CWAgent (InstanceId + ImageId)
      vars:
        final_dims: >-
          {{
            {
              'InstanceId': alarm.instance,
              'ImageId': alarm.imageid
            }
          }}
      amazon.aws.cloudwatch_metric_alarm:
        state: present
        region: "{{ region }}"
        name: "{{ alarm.name }}-MemoryUsed-{{ alarm.threshold }}%-#Alarm"
        metric_name: mem_used_percent
        namespace: CWAgent
        statistic: Average
        comparison: GreaterThanOrEqualToThreshold
        threshold: "{{ alarm.threshold }}"
        period: 300
        evaluation_periods: 1
        dimensions: "{{ final_dims }}"
        alarm_actions: "{{ sns_actions }}"
        unit: Percent
      loop: "{{ mem_alarms | default([]) }}"
      loop_control:
        loop_var: alarm
      delegate_to: localhost
      run_once: true
